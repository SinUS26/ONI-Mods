<?xml version="1.0" encoding="utf-8"?>

<Project DefaultTargets="Build" TreatAsLocalProperty="OutDir"
         xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

    <Target Name="ClearGameFolderCopyLocal" AfterTargets="ResolveAssemblyReferences">
        <ItemGroup>
            <ReferenceCopyLocalPaths Remove="$(GameFolder)\*"/>
        </ItemGroup>
    </Target>

    <Target Name="ILRepack" AfterTargets="Build">
        <ItemGroup>
	    <InputAssemblies Include="$(TargetDir)\$(ProjectName).dll"/>
<!--	    <InputAssemblies Include="..\packages\YamlDotNet.11.2.0\lib\net45\YamlDotNet.dll"/> -->
<!--	    <InputAssemblies Include="$(TargetDir)\*.dll"
                             Exclude="**\0Harmony.dll"/> -->
<!--            <InputAssemblies Include="$(LibFolder)\*.dll"
                             Exclude="**\0Harmony.dll"/> -->
        </ItemGroup>

<!--                LibraryPath="$(GameFolder)"  -->
<!--	<Exec Command="echo LibFolder = $(LibFolder)" />
	<Exec Command="echo InputAssembles = @(InputAssemblies)" /> -->
        <ILRepack
                TargetPlatformVersion="v4"
                TargetKind="SameAsPrimaryAssembly"
		LibraryPath="$(LibFolder)"
                Wildcards="true"
                InputAssemblies="@(InputAssemblies)"
                OutputFile="$(OutputPath)\$(AssemblyName).dll"
        />

    </Target>

    <Target Name="CopyArtifactsToInstallFolder" AfterTargets="ILRepack" Condition=" '$(AssemblyName)' != 'Commons' ">
<!--        <PropertyGroup Condition="'$(Configuration)' == 'VanillaRelease' Or '$(Configuration)' == 'SpacedOutRelease'">
            <InstallFolder>..\Release\$(ProjectName)</InstallFolder>
        </PropertyGroup>
        <PropertyGroup Condition="'$(Configuration)' == 'VanillaDebug' Or '$(Configuration)' == 'SpacedOutDebug'">
            <InstallFolder>$(ModFolder)\$(ProjectName)</InstallFolder> 
        </PropertyGroup>                                               -->
        <PropertyGroup Condition="'$(Configuration)' == 'VanillaRelease'">
<!--            <InstallFolder>..\Release\$(ProjectName)\archived_versions\vanilla</InstallFolder> -->
            <InstallFolder>..\Release\$(ProjectName)</InstallFolder>
	    <UseArchivedVersions>true</UseArchivedVersions>
            <SupportedContent>VANILLA_ID</SupportedContent>
            <LastWorkingBuild>466650</LastWorkingBuild>
            <APIVersion>0</APIVersion> 
        </PropertyGroup>
        <PropertyGroup Condition="'$(Configuration)' == 'SpacedOutRelease'">
            <InstallFolder>..\Release\$(ProjectName)</InstallFolder>
	    <UseArchivedVersions>false</UseArchivedVersions>
            <SupportedContent>EXPANSION1_ID</SupportedContent>
            <LastWorkingBuild>466654</LastWorkingBuild>
        </PropertyGroup>
        <PropertyGroup Condition="'$(Configuration)' == 'VanillaDebug'">
<!--            <InstallFolder>$(ModFolder)\$(ProjectName)\archived_versions\vanilla</InstallFolder>  -->
            <InstallFolder>$(UserProfile)\Documents\Klei\OxygenNotIncluded\mods\dev\$(ProjectName)</InstallFolder> 
	    <UseArchivedVersions>true</UseArchivedVersions>
            <SupportedContent>VANILLA_ID</SupportedContent>
            <LastWorkingBuild>466650</LastWorkingBuild>
        </PropertyGroup>                                               
        <PropertyGroup Condition="'$(Configuration)' == 'SpacedOutDebug'">
            <InstallFolder>$(UserProfile)\Documents\Klei\OxygenNotIncluded\mods\dev\$(ProjectName)</InstallFolder> 
	    <UseArchivedVersions>false</UseArchivedVersions>
            <SupportedContent>EXPANSION1_ID</SupportedContent>
            <LastWorkingBuild>466654</LastWorkingBuild>
        </PropertyGroup>                                               

        <PropertyGroup>
            <TempPublishFolder>$(ProjectDir)\publish</TempPublishFolder>
<!--            <UseArchivedVersions Condition="'$(UseArchivedVersions)' == ''">false</UseArchivedVersions>
            <UseArchivedVersions Condition="'$(UseArchivedVersions)' != 'true'">false</UseArchivedVersions>
            <SupportedContent Condition="'$(SupportedContent)' == ''">vanilla_id</SupportedContent>
            <LastWorkingBuild Condition="'$(LastWorkingBuild)' == ''">466654</LastWorkingBuild>
            <APIVersion Condition="'$(APIVersion)' == ''">0</APIVersion> -->
        </PropertyGroup>

        <ItemGroup>
            <!-- 
            <AnimFiles Include="$(ProjectDir)\anim\**\*.*" />
            <WorldGenFiles Include="$(ProjectDir)\worldgen\**\*.*" />
            <YamlFiles Include="$(ProjectDir)\*.yaml" />
            -->
            <YamlFiles Include="$(ProjectDir)\*.yaml"/>
            <PoFiles Include="$(ProjectDir)\**\*.po"/>
        </ItemGroup>

        <!--
        <Copy SourceFiles="@(PoFiles)" DestinationFiles="@(PoFiles->'$(TempPublishFolder)\strings\%(RecursiveDir)%(Filename)%(Extension)')"/>
        -->
        <Copy SourceFiles="@(YamlFiles)" DestinationFiles="@(YamlFiles->'$(TempPublishFolder)\%(Filename)%(Extension)')"/>
        <Copy SourceFiles="@(PoFiles)" DestinationFiles="@(PoFiles->'$(TempPublishFolder)\strings\%(Filename)%(Extension)')"/>

        <Copy SourceFiles="$(TargetPath)" DestinationFiles="$(TempPublishFolder)\$(TargetFileName)"/>


<!--	<Exec Command="echo InputFilePath=$(TempPublishFolder) OutputFilePath=$(InstallFolder) UseArchivedVersions=$(UseArchivedVersions) SupportedContent=$(SupportedContent) LastWorkingBuild=$(LastWorkingBuild) APIVersion=$(APIVersion)" /> -->


        <ModInfo InputFilePath="$(TempPublishFolder)"
                 OutputFilePath="$(InstallFolder)"
                 UseArchivedVersions="$(UseArchivedVersions)"
                 SupportedContent="$(SupportedContent)"
                 LastWorkingBuild="$(LastWorkingBuild)"
                 APIVersion="$(APIVersion)"
        />
<!--	<Exec Command="echo Ok" /> -->
        <RemoveDir Directories="$(TempPublishFolder)"/>  

        <ItemGroup>
            <DirtyFiles Include="$(InstallFolder)\**\.DS_Store"/>
        </ItemGroup>

        <Delete Files="@(DirtyFiles)"/>

    </Target>

</Project>